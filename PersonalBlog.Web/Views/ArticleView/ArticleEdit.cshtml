@{
    ViewData["Title"] = "Редактировать статью";
    Layout = "_Layout";
}

<h2>Редактировать статью</h2>

<div id="tagContainer" class="mb-2"><!-- Теги будут загружены через loadTags --></div>
<input type="text" id="titleInput" class="form-control mb-2" placeholder="Заголовок" />
<textarea id="contentInput" class="form-control mb-2" placeholder="Контент"></textarea>

<button class="btn btn-primary" onclick="saveArticle()">Сохранить</button>
<a href="/ArticleView/ArticleList">Выйти без сохранения</a>

<script>
    function getQueryParam(param) {
        return new URLSearchParams(window.location.search).get(param);
    }
        
async function loadTags() {
    const res = await fetch("/tagapi/all");
    const tags = await res.json();
    const container = document.getElementById("tagContainer"); // div для чекбоксов

    tags.forEach(t => {
        const label = document.createElement("label");
        label.classList.add("mr-2"); // отступ справа
        label.innerHTML = `
            <input type="checkbox" class="tagCheckbox" value="${t.tagId}"> ${t.tagName}
        `;
        container.appendChild(label);
    });
}

    async function loadArticle() {
        const articleId = getQueryParam("articleId");

        const res = await fetch("/articleapi/details/" + articleId);
        const article = await res.json();

        document.getElementById("titleInput").value = article.title;
        document.getElementById("contentInput").value = article.content;

        (article.tags || []).forEach(t => {
            const cb = document.querySelector(`.tagCheckbox[value="${t.tagId}"]`);
            if (cb) cb.checked = true;
        });
    }

async function saveArticle() {
    const articleId = getQueryParam("articleId");
    const title = document.getElementById("titleInput").value;
    const content = document.getElementById("contentInput").value;
    const selectedTags = Array.from(document.querySelectorAll(".tagCheckbox:checked"))
        .map(cb => cb.value);

    await fetch("/articleapi/edit/" + articleId, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ Title: title, Content: content, Tags: selectedTags })

    });
    alert("Статья обновлена");
    window.location.href = "/ArticleView/ArticleList";
}
    (async function init() {
        await loadTags();
        await loadArticle();
    })();
</script>