@{
    ViewData["Title"] = "Статья";
    Layout = "_Layout";
}

<h2 id="articleTitle"></h2>
<p>Автор: <span id="articleAuthor"></span></p>
<p id="articleContent"></p>
<div id="articleTags" class="mb-2"></div>

<hr>
<h5>Комментарии</h5>
<ul id="commentsList" class="list-group mb-2"></ul>

<textarea id="commentInput" class="form-control mb-2" placeholder="Оставьте комментарий"></textarea>
<button class="btn btn-primary" onclick="addComment()">Отправить</button>

<script>
function getQueryParam(param) {
    return new URLSearchParams(window.location.search).get(param);
}

const articleId = getQueryParam("articleId"); // берём из URL

async function loadArticle() {
    console.log("articleId =", articleId);

    // Загрузка статьи
    const res = await fetch(`/articleapi/details/${articleId}`);
    if (!res.ok) {
        console.error("Ошибка запроса:", res.status);
        return;
    }
    const a = await res.json();
    document.getElementById("articleTitle").innerText = a.title;
    document.getElementById("articleAuthor").innerText = a.authorName;
    document.getElementById("articleContent").innerText = a.content;

    // Теги
    const tagsDiv = document.getElementById("articleTags");
    tagsDiv.innerHTML = "Теги: " + (a.tags?.map(t => `<span class="badge badge-info mr-1">${t.tagName}</span>`).join("") ?? "");

    // Комментарии
    const commentsRes = await fetch(`/commentapi/${articleId}`);
    if (!commentsRes.ok) {
        console.error("Ошибка загрузки комментариев:", commentsRes.status);
        return;
    }
    const comments = await commentsRes.json();
    const commentsList = document.getElementById("commentsList");
    commentsList.innerHTML = "";
    comments.forEach(c => {
        commentsList.innerHTML += `<li class="list-group-item">${c.text}</li>`;
    });
}

async function addComment() {
    const text = document.getElementById("commentInput").value;
    if (!text.trim()) return;

    const res = await fetch("/commentapi/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ articleId: articleId, text })
    });

    if (!res.ok) {
        console.error("Ошибка добавления комментария:", res.status);
        return;
    }

    document.getElementById("commentInput").value = "";
    await loadArticle();
}

loadArticle();
</script>